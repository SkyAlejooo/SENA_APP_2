{% extends 'base.html' %}
{% load static %}
{% block title %}
    Lista de Aprendices - SENA APP Centro Minero
{% endblock %}

{% block content %}
  <div class="page-header d-flex justify-content-between align-items-center mb-4">
    <div>
      <h1 class="h3 fw-bold mb-0">Lista de Aprendices</h1>
      <p class="text-muted small mb-0">Administración de registros activos</p>
    </div>
    <div class="d-flex align-items-center gap-2">
      <span class="badge text-bg-success">
        Aprendices:
        {% if is_paginated %}
          {{ page_obj.paginator.count }}
        {% else %}
          {{ mis_aprendices|length }}
        {% endif %}
      </span>
      <a href="{% url 'aprendiz_create' %}" class="btn btn-primary shadow-sm">
        <span class="fw-semibold">+ Nuevo Aprendiz</span>
      </a>
      <a href="{% url 'admin:index' %}" class="btn btn-outline-dark shadow-sm">
        <span class="fw-semibold"><i class="bi bi-speedometer2 me-1"></i> Panel Admin</span>
      </a>
    </div>
  </div>

  <div class="card shadow-sm border-0 mb-4">
    <div class="card-body py-3 px-4 bg-light-subtle">
      <div class="row g-3 align-items-center">
        <div class="col-md-4">
          <label class="form-label fw-semibold mb-1">Buscar</label>
          <div class="input-group">
            <span class="input-group-text bg-dark text-white"><i class="bi bi-search"></i></span>
            <input type="text" id="aprendizSearch" class="form-control" placeholder="Filtrar por nombre, documento o programa..." aria-label="Buscar aprendices">
          </div>
        </div>
        <div class="col-md-4">
          <label class="form-label fw-semibold mb-1">Programa</label>
          <select id="filtroPrograma" class="form-select" aria-label="Filtrar por programa">
            <option value="" selected>Todos</option>
          </select>
        </div>
        <div class="col-md-4">
          <label class="form-label fw-semibold mb-1">Ciudad</label>
          <select id="filtroCiudad" class="form-select" aria-label="Filtrar por ciudad">
            <option value="" selected>Todas</option>
          </select>
        </div>
      </div>
    </div>
  </div>

  <div class="card shadow-sm border-0">
    <div class="card-body p-0">
      <div class="table-responsive">
        <table class="table table-striped table-hover mb-0 sena-table align-middle" id="tablaAprendices">
          <thead class="table-dark">
            <tr>
              <th><button class="table-sort" data-col="0">Documento <i class="bi bi-arrow-down-up"></i></button></th>
              <th><button class="table-sort" data-col="1">Nombre <i class="bi bi-arrow-down-up"></i></button></th>
              <th><button class="table-sort" data-col="2">Apellido <i class="bi bi-arrow-down-up"></i></button></th>
              <th><button class="table-sort" data-col="3">Teléfono <i class="bi bi-arrow-down-up"></i></button></th>
              <th><button class="table-sort" data-col="4">Correo <i class="bi bi-arrow-down-up"></i></button></th>
              <th><button class="table-sort" data-col="5">Ciudad <i class="bi bi-arrow-down-up"></i></button></th>
              <th><button class="table-sort" data-col="6">Programa <i class="bi bi-arrow-down-up"></i></button></th>
              <th class="text-end">Acciones</th>
            </tr>
          </thead>
          <tbody>
            {% for x in mis_aprendices %}
            <tr data-programa="{{ x.programa }}" data-ciudad="{{ x.ciudad }}">
              <td class="fw-semibold">{{ x.documento_identidad }}</td>
              <td>{{ x.nombre }}</td>
              <td>{{ x.apellido }}</td>
              <td>{{ x.telefono|default:'-' }}</td>
              <td><span class="badge text-bg-light text-dark">{{ x.correo }}</span></td>
              <td class="small">{{ x.ciudad }}</td>
              <td>{{ x.programa }}</td>
              <td class="text-end">
                <div class="btn-group btn-group-sm" role="group">
                  <a href="{% url 'aprendiz_detail' x.id %}" class="btn btn-outline-primary" title="Ver"><i class="bi bi-eye"></i></a>
                  <a href="{% url 'aprendiz_update' x.id %}" class="btn btn-outline-warning" title="Editar"><i class="bi bi-pencil"></i></a>
                  <a href="{% url 'aprendiz_delete' x.id %}" class="btn btn-outline-danger" title="Eliminar"><i class="bi bi-trash"></i></a>
                </div>
              </td>
            </tr>
            {% empty %}
            <tr>
              <td colspan="8" class="text-center text-muted py-4">No hay aprendices registrados.</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>

  {% if is_paginated %}
  <nav class="mt-3" aria-label="Paginación de aprendices">
    <ul class="pagination pagination-sm justify-content-end">
      {% if page_obj.has_previous %}
        <li class="page-item"><a class="page-link" href="?page={{ page_obj.previous_page_number }}">Anterior</a></li>
      {% else %}
        <li class="page-item disabled"><span class="page-link">Anterior</span></li>
      {% endif %}

      {% for p in paginator.page_range %}
        <li class="page-item {% if page_obj.number == p %}active{% endif %}"><a class="page-link" href="?page={{ p }}">{{ p }}</a></li>
      {% endfor %}

      {% if page_obj.has_next %}
        <li class="page-item"><a class="page-link" href="?page={{ page_obj.next_page_number }}">Siguiente</a></li>
      {% else %}
        <li class="page-item disabled"><span class="page-link">Siguiente</span></li>
      {% endif %}
    </ul>
  </nav>
  {% endif %}

  <div class="modal fade" id="confirmDeleteAprendiz" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title"><i class="bi bi-trash3 text-danger"></i> Confirmar eliminación</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
        </div>
        <div class="modal-body">¿Seguro que deseas eliminar este aprendiz?</div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <a id="confirmDeleteAprendizBtn" href="#" class="btn btn-danger">Eliminar</a>
        </div>
      </div>
    </div>
  </div>
{% endblock %}

{% block extra_js %}
<script src="{% static 'aprendices/js/aprendices.js' %}"></script>
<script>
  document.addEventListener('click', function(e){
    const btn = e.target.closest('#tablaAprendices a.btn.btn-outline-danger');
    if(!btn) return;
    e.preventDefault();
    const href = btn.getAttribute('href');
    const modalEl = document.getElementById('confirmDeleteAprendiz');
    const confirmBtn = document.getElementById('confirmDeleteAprendizBtn');
    confirmBtn.setAttribute('href', href);
    const modal = new bootstrap.Modal(modalEl);
    modal.show();
  });
</script>
{% endblock %}