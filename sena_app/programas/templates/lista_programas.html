{% extends 'base.html' %}
{% load static %}
{% block title %}Lista de Programas - SENA APP Centro Minero{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
  <div>
    <h1 class="h3 fw-bold mb-0">Lista de Programas</h1>
    <p class="text-muted small mb-0">Gestión y administración de programas de formación</p>
  </div>
  <div class="d-flex align-items-center gap-2">
    <span class="badge text-bg-success" data-role="programas-total">Programas: {{ total_programas }}</span>
    <a href="{% url 'programa_create' %}" class="btn btn-primary shadow-sm">
      <span class="fw-semibold">+ Nuevo Programa</span>
    </a>
    <a href="{% url 'admin:index' %}" class="btn btn-outline-dark shadow-sm">
      <span class="fw-semibold"><i class="bi bi-speedometer2 me-1"></i> Panel Admin</span>
    </a>
  </div>
</div>

<div class="card shadow-sm border-0 mb-4">
  <div class="card-body py-3 px-4 bg-light-subtle">
    <div class="row g-3 align-items-center">
      <div class="col-md-3">
        <label class="form-label fw-semibold mb-1">Buscar</label>
        <div class="input-group">
          <span class="input-group-text bg-dark text-white"><i class="bi bi-search"></i></span>
          <input type="text" id="programaSearch" class="form-control" placeholder="Filtrar por código, nombre, centro o regional..." aria-label="Buscar programas">
        </div>
      </div>
      <div class="col-md-3">
        <label class="form-label fw-semibold mb-1">Nivel de formación</label>
        <select id="filtroNivel" class="form-select" aria-label="Filtrar por nivel">
          <option value="" selected>Todos</option>
        </select>
      </div>
      <div class="col-md-3">
        <label class="form-label fw-semibold mb-1">Modalidad</label>
        <select id="filtroModalidad" class="form-select" aria-label="Filtrar por modalidad">
          <option value="" selected>Todas</option>
        </select>
      </div>
      <div class="col-md-3">
        <label class="form-label fw-semibold mb-1">Estado</label>
        <select id="filtroEstado" class="form-select" aria-label="Filtrar por estado">
          <option value="" selected>Todos</option>
          <option value="ACT">Activos</option>
          <option value="INA">Inactivos</option>
          <option value="SUS">Suspendidos</option>
          <option value="CAN">Cancelados</option>
        </select>
      </div>
    </div>
  </div>
</div>

<div class="card shadow-sm border-0">
  <div class="card-body p-0">
    <div class="table-responsive">
      <table class="table table-striped table-hover mb-0 sena-table align-middle" id="tablaProgramas">
        <thead class="table-dark">
          <tr>
            <th><button class="table-sort" data-col="0" type="button">Código <i class="bi bi-arrow-down-up"></i></button></th>
            <th><button class="table-sort" data-col="1" type="button">Nombre <i class="bi bi-arrow-down-up"></i></button></th>
            <th><button class="table-sort" data-col="2" type="button">Nivel <i class="bi bi-arrow-down-up"></i></button></th>
            <th><button class="table-sort" data-col="3" type="button">Modalidad <i class="bi bi-arrow-down-up"></i></button></th>
            <th><button class="table-sort" data-col="4" type="button">Duración (meses) <i class="bi bi-arrow-down-up"></i></button></th>
            <th><button class="table-sort" data-col="5" type="button">Centro <i class="bi bi-arrow-down-up"></i></button></th>
            <th><button class="table-sort" data-col="6" type="button">Regional <i class="bi bi-arrow-down-up"></i></button></th>
            <th class="text-end">Acciones</th>
          </tr>
        </thead>
        <tbody>
          {% for prog in programas %}
          <tr data-nivel="{{ prog.nivel_formacion }}" data-modalidad="{{ prog.modalidad }}" data-estado="{{ prog.estado }}">
            <td class="fw-semibold">{{ prog.codigo }}</td>
            <td>{{ prog.nombre }}</td>
            <td><span class="badge text-bg-warning text-dark fw-semibold">{{ prog.get_nivel_formacion_display }}</span></td>
            <td><span class="badge text-bg-dark">{{ prog.get_modalidad_display }}</span></td>
            <td>{{ prog.duracion_meses }}</td>
            <td><span class="small">{{ prog.centro_formacion }}</span></td>
            <td><span class="small">{{ prog.regional }}</span></td>
            <td class="text-end">
              <div class="btn-group btn-group-sm" role="group">
                <a href="{% url 'detalle_programa' prog.id %}" class="btn btn-outline-primary" title="Ver"><i class="bi bi-eye"></i></a>
                <a href="{% url 'programa_update' prog.id %}" class="btn btn-outline-warning" title="Editar"><i class="bi bi-pencil"></i></a>
                <a href="{% url 'programa_delete' prog.id %}" class="btn btn-outline-danger" title="Eliminar"><i class="bi bi-trash"></i></a>
              </div>
            </td>
          </tr>
          {% empty %}
          <tr><td colspan="8" class="text-center text-muted py-4">No hay programas registrados.</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>

{% if page_obj %}
<nav class="mt-3" aria-label="Paginación de programas">
  <ul class="pagination pagination-sm justify-content-end">
    {% if page_obj.has_previous %}
      <li class="page-item"><a class="page-link" href="?page={{ page_obj.previous_page_number }}">Anterior</a></li>
    {% else %}
      <li class="page-item disabled"><span class="page-link">Anterior</span></li>
    {% endif %}

    {% for p in page_obj.paginator.page_range %}
      <li class="page-item {% if page_obj.number == p %}active{% endif %}"><a class="page-link" href="?page={{ p }}">{{ p }}</a></li>
    {% endfor %}

    {% if page_obj.has_next %}
      <li class="page-item"><a class="page-link" href="?page={{ page_obj.next_page_number }}">Siguiente</a></li>
    {% else %}
      <li class="page-item disabled"><span class="page-link">Siguiente</span></li>
    {% endif %}
  </ul>
</nav>
{% endif %}

<div class="modal fade" id="confirmDeleteProgramaModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title"><i class="bi bi-trash3 text-danger"></i> Confirmar eliminación</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
      </div>
      <div class="modal-body">
        ¿Seguro que deseas eliminar este programa?
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
        <a id="confirmDeleteProgramaBtn" href="#" class="btn btn-danger">Eliminar</a>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{% static 'programas/js/programas.js' %}"></script>
<script>
  document.addEventListener('click', function(e){
    const btn = e.target.closest('a.btn.btn-outline-danger');
    if(!btn) return;
    e.preventDefault();
    const href = btn.getAttribute('href');
    const modalEl = document.getElementById('confirmDeleteProgramaModal');
    const confirmBtn = document.getElementById('confirmDeleteProgramaBtn');
    if(modalEl && confirmBtn){
      confirmBtn.setAttribute('href', href);
      const modal = new bootstrap.Modal(modalEl);
      modal.show();
    }
  });
</script>
{% endblock %}
